<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Multiplication Flash Card Game ‚Äî Voice + Tap</title>
<style>
  :root { --bg:#1f1f1f; --card:#35363a; --text:#fff; --accent:#0a84ff; --bad:#ff3b30; --good:#32d74b; }
  * { box-sizing: border-box; }
  html, body { height: 100%; }
  body {
    margin:0;
    font-family: -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    background: var(--bg);
    color: var(--text);
    display:flex; flex-direction:column; align-items:center; justify-content:center;
    gap:16px; padding:16px;
    -webkit-tap-highlight-color: transparent;
  }
  .topbar { position:fixed; top:0; left:0; right:0; padding:10px 12px; display:flex; gap:8px; justify-content:center; background:rgba(0,0,0,.2); backdrop-filter: blur(6px); }
  .pill { font-size:.95em; padding:6px 10px; border-radius:999px; background:#2a2a2a; border:1px solid #444; display:inline-flex; align-items:center; gap:6px; }
  .pill .dot { width:8px; height:8px; border-radius:999px; background:#888; }
  .pill .dot.on { background: var(--good); }
  .pill .dot.off { background: #888; }
  .card {
    width:min(92vw, 420px);
    background: var(--card);
    border-radius:16px;
    padding:28px;
    text-align:center;
    font-size: clamp(28px, 7vw, 48px);
    box-shadow: 0 10px 30px rgba(0,0,0,.3);
    user-select:none;
    cursor:pointer;
    transition: transform .08s ease, background .2s ease;
  }
  .card:active { transform: scale(.99); background:#3c3d42; }
  .sub { font-size:.6em; opacity:.9; margin-top:8px; }
  .row { display:flex; gap:10px; justify-content:center; flex-wrap:wrap; }
  button {
    appearance:none; border:none; border-radius:10px; padding:10px 16px;
    font-size:1rem; font-weight:600; color:#fff; background:var(--accent);
    cursor:pointer;
  }
  button.bad { background: var(--bad); }
  button.good { background: var(--good); color:#001b07; }
  button.secondary { background:#2f2f2f; border:1px solid #454545; }
  .buttons { display:none; gap:10px; }
  #score { font-size:1rem; opacity:.9; }
  .meta { display:flex; gap:12px; align-items:center; flex-wrap:wrap; justify-content:center; }
  .timer { font-variant-numeric: tabular-nums; min-width: 3ch; }
  .transcript { max-width:min(92vw, 440px); background:#2a2a2a; border:1px solid #404040; border-radius:12px; padding:10px 12px; font-size:.95rem; }
  .hint { opacity:.8; font-size:.9rem; }
  .warn { color:#ffd60a; font-size:.9rem; margin-top:4px; }
  .hidden { display:none !important; }
</style>
</head>
<body>

<div class="topbar">
  <span class="pill"><span id="voiceDot" class="dot off"></span><span id="voiceLabel">Voice: Off</span></span>
  <span class="pill"><span>‚è±Ô∏è</span> <span class="timer" id="countdown">‚Äî</span>s</span>
  <span class="pill" id="score">Score: 0 / 0</span>
</div>

<div id="question" class="card" aria-live="polite">Tap to Start
  <div class="sub">‚Ä¶or enable voice below and speak the answer</div>
</div>

<div class="row buttons" id="buttonsRow">
  <button id="correctBtn" class="good">‚úÖ Correct</button>
  <button id="wrongBtn" class="bad">‚ùå Incorrect</button>
  <button id="nextBtn" class="secondary">‚û°Ô∏è Next</button>
</div>

<div class="row">
  <button id="toggleVoice" class="secondary">üé§ Enable Voice</button>
</div>

<div id="transcriptBox" class="transcript hidden">
  <div><strong>Heard:</strong> <span id="heard">‚Äî</span></div>
  <div class="hint">Say the number only (e.g., ‚Äúforty two‚Äù or ‚Äú42‚Äù).</div>
  <div id="secureWarn" class="warn hidden">Microphone requires opening this page over HTTPS (not a file:// URL).</div>
  <div id="supportWarn" class="warn hidden">Speech recognition not supported in this browser.</div>
</div>

<script>
(() => {
  let num1=0, num2=0, answer=0;
  let correctCount=0, totalCount=0;
  let revealTimer=null, countdownTimer=null, countdown=10;
  let showingAnswer=false;
  let voiceOn=false, recognition=null, canUseVoice=false;

  const card = document.getElementById('question');
  const buttonsRow = document.getElementById('buttonsRow');
  const correctBtn = document.getElementById('correctBtn');
  const wrongBtn = document.getElementById('wrongBtn');
  const nextBtn = document.getElementById('nextBtn');
  const scoreEl = document.getElementById('score');
  const countdownEl = document.getElementById('countdown');
  const toggleVoiceBtn = document.getElementById('toggleVoice');
  const transcriptBox = document.getElementById('transcriptBox');
  const heardEl = document.getElementById('heard');
  const voiceDot = document.getElementById('voiceDot');
  const voiceLabel = document.getElementById('voiceLabel');
  const secureWarn = document.getElementById('secureWarn');
  const supportWarn = document.getElementById('supportWarn');

  function rand15(){ return Math.floor(Math.random()*10)+1; }

  function startCountdown() {
    clearInterval(countdownTimer);
    countdown = 10;
    countdownEl.textContent = countdown;
    countdownTimer = setInterval(() => {
      countdown--;
      countdownEl.textContent = countdown;
      if (countdown <= 0) {
        clearInterval(countdownTimer);
      }
    }, 1000);
  }

  function newProblem(){
    showingAnswer=false;
    buttonsRow.style.display='none';
    card.textContent='Get Ready‚Ä¶';
    card.appendChild(document.createElement('div')).className='sub';
    setTimeout(()=>{
      num1 = rand15(); num2 = rand15(); answer = num1*num2;
      renderQuestion();
      scheduleReveal();
      if (voiceOn) startListening(); // kick off speech during question
    }, 500);
  }

  function renderQuestion(){
    card.innerHTML = `${num1} √ó ${num2}`;
    const sub = document.createElement('div');
    sub.className='sub';
    sub.textContent = voiceOn ? 'Say your answer‚Ä¶ or tap to reveal' : 'Tap to reveal the answer';
    card.appendChild(sub);
    startCountdown();
  }

  function scheduleReveal(){
    clearTimeout(revealTimer);
    revealTimer = setTimeout(showAnswer, 10000);
  }

  function showAnswer(){
    if (showingAnswer) return;
    showingAnswer = true;
    clearTimeout(revealTimer);
    clearInterval(countdownTimer);
    card.textContent = `${num1} √ó ${num2} = ${answer}`;
    buttonsRow.style.display='flex';
    // when auto-scored by voice, we can nudge buttons state, but keep manual available
  }

  function updateScore(){
    scoreEl.textContent = `Score: ${correctCount} / ${totalCount}`;
  }

  function handleTap(){
    const t = card.textContent;
    if (t.includes('Start') || t.includes('Ready')) {
      newProblem();
    } else if (t.includes('√ó') && !t.includes('=')) {
      showAnswer();
    }
  }

  card.addEventListener('click', handleTap);
  card.addEventListener('touchstart', handleTap, {passive:true});

  correctBtn.addEventListener('click', ()=>{
    correctCount++; totalCount++; updateScore(); newProblem();
  });
  wrongBtn.addEventListener('click', ()=>{
    totalCount++; updateScore(); newProblem();
  });
  nextBtn.addEventListener('click', ()=> newProblem());

  // ---------- VOICE (SpeechRecognition) ----------
  function checkSecure(){
    const isSecure = location.protocol === 'https:' || location.hostname === 'localhost';
    secureWarn.classList.toggle('hidden', isSecure);
    return isSecure;
  }
  function getsr(){
    return window.SpeechRecognition || window.webkitSpeechRecognition || null;
  }
  function initVoice(){
    const SR = getsr();
    canUseVoice = !!SR;
    supportWarn.classList.toggle('hidden', !!SR);
    transcriptBox.classList.remove('hidden');
    if (!canUseVoice) return;
    recognition = new SR();
    recognition.lang = 'en-US';
    recognition.interimResults = true;
    recognition.maxAlternatives = 1;
    recognition.continuous = false;

    recognition.onresult = e => {
      const t = Array.from(e.results).map(r=>r[0].transcript).join(' ').trim();
      heardEl.textContent = t || '‚Äî';
      // If final result available, try to score immediately
      if (e.results[0] && e.results[0].isFinal) {
        const guess = parseHeardNumber(t);
        if (guess != null) autoScore(guess);
      }
    };
    recognition.onend = () => {
      // If still on question (not revealed yet) and voice is on, restart to keep listening
      if (voiceOn && !showingAnswer) {
        try { recognition.start(); } catch(e){ /* ignore */ }
      }
    };
    recognition.onerror = (ev) => {
      // Common errors: "no-speech", "aborted", "not-allowed"
      // Keep UI on; user can try again or toggle voice off/on.
      console.warn('Speech error:', ev.error);
    };
  }

  function setVoiceUI(on){
    voiceOn = on;
    voiceDot.classList.toggle('on', on);
    voiceDot.classList.toggle('off', !on);
    voiceLabel.textContent = on ? 'Voice: On' : 'Voice: Off';
    toggleVoiceBtn.textContent = on ? 'üé§ Disable Voice' : 'üé§ Enable Voice';
    transcriptBox.classList.toggle('hidden', !on && !supportWarn.classList.contains('hidden'));
  }

  function startListening(){
    if (!checkSecure()) return;
    if (!recognition) return;
    try { recognition.stop(); } catch(e){}
    try { recognition.start(); } catch(e){ /* starting too fast can throw; ignore */ }
  }
  function stopListening(){
    if (recognition) {
      try { recognition.stop(); } catch(e){}
    }
  }

  toggleVoiceBtn.addEventListener('click', async ()=>{
    if (!getsr()) { initVoice(); return; }
    if (!checkSecure()) { initVoice(); return; }
    if (!recognition) initVoice();
    if (!voiceOn) {
      setVoiceUI(true);
      startListening();
      if (card.textContent.includes('Start')) newProblem();
    } else {
      setVoiceUI(false);
      stopListening();
    }
  });

  // --------- Number parsing from transcript ----------
  const units = {zero:0, one:1, two:2, three:3, four:4, five:5, six:6, seven:7, eight:8, nine:9,
                 ten:10, eleven:11, twelve:12, thirteen:13, fourteen:14, fifteen:15, sixteen:16,
                 seventeen:17, eighteen:18, nineteen:19};
  const tens = {twenty:20, thirty:30, forty:40, fourty:40, fifty:50, sixty:60, seventy:70, eighty:80, ninety:90};
  function wordsToNumber(str){
    str = str.toLowerCase().replace(/[^a-z0-9\s-]/g,' ').replace(/ +/g,' ').trim();
    if (!str) return null;
    // direct digits first
    const m = str.match(/\d+/);
    if (m) return parseInt(m[0],10);
    let total = 0, current = 0;
    const parts = str.split(/[\s-]+/);
    for (const w of parts) {
      if (w === 'and') continue;
      if (units[w] != null) { current += units[w]; continue; }
      if (tens[w] != null) { current += tens[w]; continue; }
      if (w === 'hundred') { if (current===0) current = 1; current *= 100; continue; }
      // unrecognized word resets? ignore
    }
    total += current;
    return isNaN(total) ? null : total;
  }

  function parseHeardNumber(t){
    const n = wordsToNumber(t);
    return (n != null && isFinite(n)) ? n : null;
  }

  // Auto-scoring
  function flashColor(ok){
    card.style.background = ok ? 'rgba(50,215,75,.25)' : 'rgba(255,59,48,.25)';
    setTimeout(()=>{ card.style.background = getComputedStyle(document.documentElement).getPropertyValue('--card') || '#35363a'; }, 250);
  }
  function autoScore(guess){
    // Only during question phase
    if (showingAnswer) return;
    heardEl.textContent = `${heardEl.textContent}  ‚Üí  ${guess}`;
    showAnswer();
    totalCount++;
    if (guess === answer) {
      correctCount++; flashColor(true);
    } else {
      flashColor(false);
    }
    updateScore();
  }

  // Initial state
  updateScore();
  countdownEl.textContent = '‚Äî';

  // Feature detection banners
  initVoice(); // prepare warnings; won't start mic until user taps
  setVoiceUI(false);
  checkSecure();
})();
</script>

</body>
</html>
